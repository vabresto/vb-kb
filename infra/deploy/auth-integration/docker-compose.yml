services:
  keycloak:
    image: quay.io/keycloak/keycloak:26.1
    command:
      - start-dev
      - --import-realm
      - --http-port=8080
    environment:
      KEYCLOAK_ADMIN: "${KEYCLOAK_ADMIN:-admin}"
      KEYCLOAK_ADMIN_PASSWORD: "${KEYCLOAK_ADMIN_PASSWORD:-change-me-admin-password}"
      KC_PROXY_HEADERS: xforwarded
      KC_HOSTNAME_STRICT: "false"
    volumes:
      - vb_kb_auth_it_keycloak_data:/opt/keycloak/data
      - ../shared/keycloak/realm-vb-kb.json:/opt/keycloak/data/import/realm-vb-kb.json:ro
    networks:
      - auth-it

  kb-mcp:
    image: vb-kb:latest
    build:
      context: ../../..
      dockerfile: infra/deploy/shared/Dockerfile
    depends_on:
      - keycloak
    command:
      - kb
      - mcp-server
      - --project-root
      - /repo
      - --data-root
      - /repo/data
      - --transport
      - streamable-http
      - --host
      - 0.0.0.0
      - --port
      - "8001"
      - --path
      - /mcp
    environment:
      KB_MCP_OAUTH_MODE: external-jwt
      KB_MCP_OAUTH_BASE_URL: http://kb-mcp:8001
      KB_MCP_EXTERNAL_AUTHORIZATION_SERVERS: "http://keycloak:8080/realms/${KEYCLOAK_REALM:-vb-kb}"
      KB_MCP_EXTERNAL_JWT_JWKS_URI: "http://keycloak:8080/realms/${KEYCLOAK_REALM:-vb-kb}/protocol/openid-connect/certs"
      KB_MCP_EXTERNAL_JWT_ISSUER: "http://keycloak:8080/realms/${KEYCLOAK_REALM:-vb-kb}"
      KB_MCP_EXTERNAL_JWT_AUDIENCE: "${KEYCLOAK_CLIENT_ID:-vb-kb-mcp-confidential}"
      KB_MCP_EXTERNAL_JWT_ALGORITHM: RS256
      KB_MCP_EXTERNAL_REQUIRED_SCOPES: "${KB_MCP_EXTERNAL_REQUIRED_SCOPES:-}"
    volumes:
      - ../../..:/repo:ro
    networks:
      - auth-it

  auth-integration-tests:
    image: python:3.13-slim
    depends_on:
      - keycloak
      - kb-mcp
    command:
      - python
      - /repo/infra/deploy/auth-integration/tests/run_external_jwt_flow.py
    environment:
      KEYCLOAK_BASE_URL: http://keycloak:8080
      MCP_BASE_URL: http://kb-mcp:8001
      KEYCLOAK_REALM: "${KEYCLOAK_REALM:-vb-kb}"
      KEYCLOAK_CLIENT_ID: "${KEYCLOAK_CLIENT_ID:-vb-kb-mcp-confidential}"
      KEYCLOAK_CLIENT_SECRET: "${KEYCLOAK_CLIENT_SECRET:-change-me-vb-kb-client-secret}"
      TEST_TIMEOUT_SECONDS: "${TEST_TIMEOUT_SECONDS:-240}"
    volumes:
      - ../../..:/repo:ro
    networks:
      - auth-it

volumes:
  vb_kb_auth_it_keycloak_data:

networks:
  auth-it:
    internal: true
